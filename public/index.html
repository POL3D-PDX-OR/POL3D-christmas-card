<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>POL3D ‚Äî kartka ≈õwiƒÖteczna</title>
<style>
  :root{
    --bg1:#143b2a; --bg2:#8b0f1a;
    --panel:rgba(20,20,24,.42);
    --card:#fff7ea; --ink:#173b2e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:#fff; overflow:hidden;
    background:
      radial-gradient(1200px 800px at 15% 25%, rgba(255,255,255,.10), transparent 60%),
      radial-gradient(900px 650px at 80% 80%, rgba(255,255,255,.08), transparent 65%),
      linear-gradient(115deg, var(--bg1), #2a2a2a 40%, var(--bg2));
  }
  header{
    position:fixed; inset:0 0 auto 0; height:64px;
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px;
    background:linear-gradient(to bottom, rgba(0,0,0,.70), rgba(0,0,0,.18));
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
    z-index:50;
  }
  header .title{display:flex; flex-direction:column; gap:2px; max-width:min(920px, 70vw);}
  header h1{margin:0; font-size:18px; font-weight:800;}
  header .sub{margin:0; font-size:13px; opacity:.9; line-height:1.2;}
  header .actions{display:flex; gap:10px; align-items:center;}
  .pill{
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.14);
    border-radius:999px;
    padding:10px 12px;
    font-size:14px; cursor:pointer; user-select:none;
    backdrop-filter: blur(10px);
  }
  .pill.primary{
    background:linear-gradient(180deg, rgba(255,222,140,.35), rgba(255,222,140,.18));
    border-color: rgba(255,222,140,.35);
    font-weight:700;
  }

  .wrap{
    position:fixed; inset:64px 0 0 0;
    display:grid; grid-template-columns: 340px 1fr;
    gap:16px; padding:14px 16px 16px;
  }
  aside{
    background:var(--panel);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px; padding:12px;
    backdrop-filter: blur(12px);
    overflow:auto;
  }
  .section{
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    padding:12px; margin-bottom:12px;
  }
  .section h2{
    margin:0 0 8px 0; font-size:14px; letter-spacing:.2px; opacity:.95;
    display:flex; align-items:center; justify-content:space-between;
  }
  .hint{font-size:12px; opacity:.88; line-height:1.35;}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .tile{
    display:flex; flex-direction:column; gap:6px;
    border-radius:14px; padding:10px;
    background:rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.10);
    cursor:pointer; user-select:none;
    transition: transform .12s ease, background .12s ease;
  }
  .tile:hover{ transform: translateY(-1px); background:rgba(0,0,0,.22); }
  .thumb{
    height:54px; border-radius:12px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.10);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .thumb img{max-height:100%; max-width:100%; display:block;}
  .thumb .emoji{font-size:34px; filter: drop-shadow(0 10px 10px rgba(0,0,0,.25));}
  .tile .lbl{font-size:12px; opacity:.92; text-align:center;}

  label{font-size:12px; opacity:.9}
  select,input[type="text"]{
    width:100%;
    background:rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.12);
    color:#fff; border-radius:12px;
    padding:10px 10px; outline:none;
  }
  details summary{
    list-style:none; cursor:pointer; font-weight:700;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 10px; border-radius:14px;
    background:rgba(0,0,0,.18);
    border:1px solid rgba(255,255,255,.10);
  }
  details summary::-webkit-details-marker{display:none}
  details .content{padding-top:10px}

  .stage{
    position:relative; overflow:hidden;
    border-radius:22px;
    display:flex; align-items:center; justify-content:center;
  }
  .card-wrap{
    position:relative;
    width:min(1080px, calc(100vw - 340px - 70px));
    aspect-ratio:1/1;
    border-radius:28px; padding:14px;
  }
  .card{
    position:absolute; inset:0;
    border-radius:28px;
    background:
      radial-gradient(800px 520px at 20% 30%, rgba(255,210,230,.65), transparent 60%),
      radial-gradient(820px 560px at 80% 22%, rgba(255,230,160,.72), transparent 60%),
      radial-gradient(520px 520px at 50% 80%, rgba(255,255,255,.85), rgba(255,255,255,.65) 60%, rgba(255,255,255,.55));
    box-shadow:
      0 40px 120px rgba(0,0,0,.45),
      0 10px 40px rgba(0,0,0,.25);
    border:6px solid rgba(255,244,220,.95);
    overflow:hidden;
  }
  .card:before{
    content:"";
    position:absolute; inset:10px;
    border-radius:22px;
    border:2px dashed rgba(150,120,90,.35);
    pointer-events:none;
    z-index:2;
  }
  .watermark{
    position:absolute; inset:0;
    pointer-events:none;
    opacity:.16;
    background-repeat:no-repeat;
    background-position:center;
    background-size: var(--wmSize, 82%) auto;
    transform: rotate(var(--wmRot, -2deg));
    z-index:1;
  }
  .lights{
    position:absolute; left:20px; right:20px; top:10px;
    height:26px; display:flex; justify-content:space-between; align-items:center;
    pointer-events:none;
    z-index:3;
  }
  .bulb{width:12px; height:12px; border-radius:999px; box-shadow: 0 10px 18px rgba(0,0,0,.22);}

  .card-ui{
    position:absolute; inset:0;
    padding:46px 54px 54px;
    color:#263328;
    z-index:4;
    pointer-events:auto;
  }
  .headline{
    text-align:center;
    font-size:46px;
    color:var(--ink);
    font-weight:900;
    margin:10px 0 6px 0;
    letter-spacing:.3px;
    text-shadow: 0 2px 0 rgba(255,255,255,.6);
  }
  .deck{
    text-align:center;
    font-size:18px;
    margin:0 auto 14px;
    max-width:820px;
    color:#3a3a3a;
    line-height:1.35;
  }
  .tofrom{
    display:flex; justify-content:center; gap:12px;
    margin:0 0 12px 0; flex-wrap:wrap;
  }
  .chip{
    display:flex; align-items:center; gap:10px;
    background:rgba(255,255,255,.78);
    border:1px solid rgba(0,0,0,.08);
    border-radius:999px;
    padding:10px 14px;
    box-shadow: 0 16px 28px rgba(0,0,0,.10);
  }
  .chip b{font-size:14px;}
  .chip input{
    width:auto; min-width:240px;
    background:transparent;
    border:none; color:#2a2a2a;
    padding:0; font-size:14px; outline:none;
  }

  /* sticker elements layer (CRITICAL FIX) */
  .elem{
    position:absolute;
    left:0; top:0;
    transform-origin:center;
    user-select:none;
    cursor:grab;
    will-change: transform;
    z-index:10;
    touch-action:none; /* critical for pointer events */
  }
  .elem.selected{ outline:2px dashed rgba(80,120,255,.55); outline-offset:8px; border-radius:16px;}
  .elem img{display:block; max-width:none; pointer-events:none;}
  .elem .emoji{font-size:70px; line-height:1; filter: drop-shadow(0 14px 14px rgba(0,0,0,.20)); pointer-events:none;}
  .elem .text{
    font-weight:900; font-size:56px; color:#111; letter-spacing:.5px;
    text-shadow: 0 10px 24px rgba(0,0,0,.18);
    background:rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.06);
    padding:10px 14px;
    border-radius:16px;
    pointer-events:none;
    white-space:nowrap;
  }

  .dock{
    position:fixed; right:16px; bottom:16px;
    z-index:60; display:flex; gap:8px;
    padding:10px; border-radius:16px;
    background:rgba(255,255,255,.18);
    border:1px solid rgba(255,255,255,.20);
    backdrop-filter: blur(12px);
  }
  .btn{
    width:44px; height:44px;
    border-radius:14px;
    background:rgba(255,255,255,.16);
    border:1px solid rgba(255,255,255,.18);
    color:#fff; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    font-weight:900; user-select:none;
  }
  .btn:hover{background:rgba(255,255,255,.22)}
  .btn.blue{background:rgba(90,170,255,.22)}

  #snow{ position:fixed; inset:0; pointer-events:none; z-index:40; }

  /* error bar */
  .errbar{
    position:fixed; left:16px; right:16px; bottom:16px;
    z-index:120;
    display:none;
    background:rgba(160,0,0,.65);
    border:1px solid rgba(255,255,255,.18);
    border-radius:14px;
    padding:10px 12px;
    backdrop-filter: blur(10px);
    font-size:13px;
  }
  .errbar code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;}

  /* export modal */
  .modal{
    position:fixed; inset:0;
    z-index:200;
    display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.65);
    padding:18px;
  }
  .modal .box{
    width:min(980px, 96vw);
    background:rgba(20,20,24,.92);
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    padding:12px;
    backdrop-filter: blur(12px);
  }
  .modal .top{
    display:flex; justify-content:space-between; align-items:center; gap:12px;
    padding:6px 6px 10px 6px;
  }
  .modal .top .t{font-weight:800}
  .modal .actions{display:flex; gap:8px; align-items:center;}
  .modal img{width:100%; height:auto; display:block; border-radius:14px; border:1px solid rgba(255,255,255,.12);}

  @media (max-width: 980px){
    .wrap{grid-template-columns: 1fr;}
    .stage{order:-1;}
    .card-wrap{width:min(980px, 92vw);}
  }
</style>
</head>
<body>

<header>
  <div class="title">
    <h1>POL3D ‚Äî Polska w trzech wymiarach</h1>
    <p class="sub">≈öwiƒÖteczna zabawa i premiera projektu m≈Çodzie≈ºy z Polskiej Szko≈Çy w Portland. U≈Ç√≥≈º kartkƒô jak naklejki i wy≈õlij dalej.</p>
  </div>
  <div class="actions">
    <div class="pill" id="toggleSnow">≈önieg: ON</div>
    <div class="pill" id="toggleSound">D≈∫wiƒôki: OFF</div>
    <div class="pill primary" id="exportBtn">Wyeksportuj gotowƒÖ poczt√≥wkƒô</div>
  </div>
</header>

<canvas id="snow"></canvas>

<div class="wrap">
  <aside>
    <div class="section">
      <div class="hint">
        U≈Ç√≥≈º elementy logo na delikatnych ‚Äûmiejscach‚Äù w tle, dodaj ≈õwiƒÖteczne naklejki i w≈Çasne pliki. Kliknij element, aby go zaznaczyƒá. K√≥≈Çko myszy = skala. Dwuklik na tek≈õcie = edycja.
      </div>

      <details style="margin-top:10px">
        <summary>≈πr√≥d≈Ço plik√≥w logo (opcjonalnie) <span>‚ñæ</span></summary>
        <div class="content">
          <div class="mini" style="margin-bottom:8px; opacity:.88">
            Wybierz folder z plikami graficznymi tylko wtedy, gdy otwierasz tƒô stronƒô jako <code>file://</code> i eksport PNG by≈Ç blokowany.
          </div>
          <div class="row" style="align-items:center">
            <input id="assetFolder" type="file" webkitdirectory multiple style="flex:1"/>
            <div class="pill" style="cursor:default"><span id="assetStatus">0/0</span></div>
          </div>
        </div>
      </details>
    </div>

<div class="section">
      <h2>Naklejki POL3D ‚Äî uk≈Çadanka logo</h2>
      <div class="grid2" id="logoTiles"></div>
      <div style="height:10px"></div>
      <label for="hoodColor">Je≈õli dodasz kolorowy Mt. Hood ‚Äî mo≈ºesz zmieniƒá jego kolor:</label>
      <select id="hoodColor">
        <option value="orig">Orygina≈Ç</option>
        <option value="rg">≈öwiƒÖteczny (czerw./ziele≈Ñ)</option>
        <option value="wb">Bia≈Ço-czerwony (subtelnie)</option>
        <option value="cool">Ch≈Çodny (zimowy)</option>
      </select>
      <div class="mini" style="margin-top:6px; opacity:.85">Uwaga: filtr dotyczy tylko elementu ‚ÄûMt. Hood (kolor)‚Äù.</div>
    </div>

    <details class="section" open>
      <summary>≈öwiƒÖteczne naklejki <span>‚ñæ</span></summary>
      <div class="content">
        <div class="grid2" id="holidayTiles"></div>
      </div>
    </details>

    <details class="section">
      <summary>Dodaj w≈Çasne pliki <span>‚ñæ</span></summary>
      <div class="content">
        <label>Dodaj naklejkƒô (PNG/JPG/WEBP)</label>
        <input id="fileSticker" type="file" accept="image/png,image/jpeg,image/webp"/>
        <div style="height:10px"></div>
        <label>Dodaj zdjƒôcie (PNG/JPG/WEBP)</label>
        <input id="filePhoto" type="file" accept="image/png,image/jpeg,image/webp"/>
        <div style="height:10px"></div>
        <label>Dodaj tekst (sticker)</label>
        <input id="addText" type="text" placeholder="Np. Weso≈Çych ≈öwiƒÖt!"/>
        <div style="margin-top:8px">
          <div class="pill" id="addTextBtn" style="display:inline-block">Dodaj tekst</div>
        </div>
      </div>
    </details>

    <details class="section">
      <summary>Rozmiar eksportu <span>‚ñæ</span></summary>
      <div class="content">
        <label>Rozmiar (domy≈õlnie 1080√ó1080 IG)</label>
        <select id="formatSel">
          <option value="1080x1080">1080√ó1080 (Instagram / kwadrat)</option>
          <option value="1920x1080">1920√ó1080 (HD / 16:9)</option>
          <option value="1200x630">1200√ó630 (Facebook link / 1.91:1)</option>
          <option value="1600x900">1600√ó900 (lekki 16:9)</option>
        </select>
      </div>
    </details>
  </aside>

  <main class="stage">
    <div class="card-wrap" id="cardWrap">
      <div class="card" id="card">
        <div class="watermark" id="wm"></div>
        <div class="lights" id="lights"></div>
        <div class="card-ui">
          <div class="headline">Weso≈Çych ≈öwiƒÖt od POL3D!</div>
          <div class="deck">
            POL3D to projekt m≈Çodzie≈ºy z Polskiej Szko≈Çy w Portland: od pomys≈Çu, przez prototyp, a≈º po sprzeda≈º. Z tej okazji ‚Äî baw siƒô kartkƒÖ i rozsy≈Çaj dalej.
          </div>
          <div class="tofrom">
            <div class="chip"><b>üåü Dla:</b><input id="toField" value="Rodziny i Przyjaci√≥≈Ç"/></div>
            <div class="chip"><b>üéÅ Od:</b><input id="fromField" value="Zesp√≥≈Ç POL3D"/></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="dock" id="dock" style="display:none">
  <div class="btn" id="bPlus">+</div>
  <div class="btn" id="bMinus">‚àí</div>
  <div class="btn" id="bRot">‚ü≤</div>
  <div class="btn" id="bDown">‚¨á</div>
  <div class="btn blue" id="bUp">‚¨Ü</div>
  <div class="btn" id="bDel">üóë</div>
</div>

<div class="errbar" id="errbar"></div>

<div class="modal" id="modal">
  <div class="box">
    <div class="top">
      <div class="t">Eksport PNG</div>
      <div class="actions">
        <a class="pill primary" id="downloadLink" href="#" download="POL3D_kartka.png">Pobierz PNG</a>
        <div class="pill" id="closeModal">Zamknij</div>
      </div>
    </div>

    <img id="previewImg" alt="PodglƒÖd eksportu"/>

    <div class="sendrow" style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
      <input id="emailTo" type="email" placeholder="Adres e-mail odbiorcy" style="flex:1; min-width:240px"/>
      <div class="pill primary" id="sendEmailBtn">Wy≈õlij e-mailem</div>
      <div class="pill" id="shareBtn">Udostƒôpnij</div>
    </div>
    <div class="mini" id="sendStatus" style="margin-top:8px; opacity:.9"></div>
  </div>
</div>

<script>
/* ========= ASSETS (by filename) ========= */
const ASSET_NAMES = {
  watermark: "POL3D_WATERMARK_OUTLINES.png",
  pol: "POL3D_TXT-POL.png",
  threeD: "POL3D_TXT-3D.png",
  dotcom: "POL3D_TXT-.com.png",
  tagline: "POL3D_TXT-POLwTRZECH-W.png",
  hoodColor: "POL3D_MT.HOOD_COLOR.png",
  hoodWire: "POL3D_MT.HOOD_WIRE_w_HORIZON.png",
  emojiO: "POL3D-O-EMIOJI-OCZKO-ANIMA-L.gif"
};

// map filename -> objectURL (from folder picker or from custom uploads)
const assetMap = new Map();

/* ========= ERROR UI ========= */
function showError(msg, err){
  const el = document.getElementById("errbar");
  const extra = err ? ("\n" + (err.name? err.name + ": " : "") + (err.message || String(err))) : "";
  el.style.display = "block";
  el.innerHTML = "<b>B≈ÅƒÑD JS:</b> " + escapeHtml(msg) + (extra ? "<br><code>" + escapeHtml(extra) + "</code>" : "");
}
function clearError(){ document.getElementById("errbar").style.display = "none"; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }
window.addEventListener("error", (e)=>{ showError(e.message || "Nieznany b≈ÇƒÖd", e.error); });
window.addEventListener("unhandledrejection", (e)=>{ showError("Promise rejection", e.reason); });

/* ========= RESOLVE URL ========= */
function resolveAsset(name){
  // 1) if user picked folder -> objectURL
  if(assetMap.has(name)) return assetMap.get(name);
  // 2) try relative path (works on http://localhost)
  return name;
}
function requireAssetOrExplain(name){
  const url = resolveAsset(name);
  // if running as file:// and asset not in map, warn user
  if(location.protocol === "file:" && !assetMap.has(name)){
    showError("Uruchamiasz z dysku (file://). Aby uniknƒÖƒá SecurityError przy eksporcie, wybierz folder z assetami w panelu po lewej.", null);
    return null;
  }
  return url;
}

/* ========= STATE ========= */
const card = document.getElementById("card");
const cardWrap = document.getElementById("cardWrap");
const wmDiv = document.getElementById("wm");
const dock = document.getElementById("dock");
const formatSel = document.getElementById("formatSel");
const assetStatus = document.getElementById("assetStatus");

let snowOn = true;
let soundOn = false; // default OFF to avoid AudioContext surprises on some setups

const state = {
  elems: [],
  selectedId: null,
  nextId: 1
};
function uid(){ return state.nextId++; }
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
function perfNow(){ return performance.now(); }
function cardRect(){ return card.getBoundingClientRect(); }
function localXY(clientX, clientY){
  const r = cardRect();
  return { x: (clientX - r.left), y: (clientY - r.top) };
}

/* ========= ELEMENTS DOM ========= */
function createElemDOM(e){
  const el = document.createElement("div");
  el.className = "elem";
  el.dataset.id = e.id;

  if(e.type==="img"){
    const img = document.createElement("img");
    img.alt = "";
    img.src = e.src;
    img.draggable = false;
    el.appendChild(img);
  }else if(e.type==="emoji"){
    const d = document.createElement("div");
    d.className = "emoji";
    d.textContent = e.char;
    el.appendChild(d);
  }else if(e.type==="text"){
    const d = document.createElement("div");
    d.className = "text";
    d.textContent = e.text;
    el.appendChild(d);
    el.addEventListener("dblclick", ()=>{
      const nv = prompt("Edytuj tekst:", e.text);
      if(nv!==null){
        e.text = nv.trim() || e.text;
        d.textContent = e.text;
      }
    });
  }

  card.appendChild(el);
  wireDrag(el);
  return el;
}

function renderAll(){
  state.elems.sort((a,b)=>a.z-b.z);
  const doms = Array.from(card.querySelectorAll(".elem"));
  const byId = new Map(doms.map(d=>[Number(d.dataset.id), d]));

  for(const e of state.elems){
    let el = byId.get(e.id);
    if(!el){
      el = createElemDOM(e);
      byId.set(e.id, el);
    }
    if(e.type==="img"){
      const img = el.querySelector("img");
      if(img && img.src !== e.src) img.src = e.src;

      if(e.meta?.kind==="photo"){
        img.style.filter = "saturate(1.05) contrast(1.02)";
        img.style.boxShadow = "0 18px 40px rgba(0,0,0,.25)";
        img.style.borderRadius = "16px";
      }else{
        img.style.filter = "drop-shadow(0 16px 18px rgba(0,0,0,.22))";
      }
      if(e.meta?.hoodColorable){
        img.style.filter = hoodFilterCSS(document.getElementById("hoodColor").value);
      }
    }else if(e.type==="emoji"){
      const d = el.querySelector(".emoji"); if(d) d.textContent = e.char;
    }else if(e.type==="text"){
      const d = el.querySelector(".text"); if(d) d.textContent = e.text;
    }

    const floatY = (e.floatAmp||0) * Math.sin(perfNow()/1000 + (e.floatPhase||0));
    const tx = e.x, ty = e.y + floatY;
    el.style.transform = `translate(${tx}px, ${ty}px) translate(-50%, -50%) rotate(${e.r}deg) scale(${e.s})`;
    el.style.zIndex = String(e.z);
    el.classList.toggle("selected", e.id===state.selectedId);
  }

  for(const d of doms){
    const id = Number(d.dataset.id);
    if(!state.elems.find(e=>e.id===id)) d.remove();
  }
}

/* ========= DRAG/SELECT ========= */
let drag = null;
function wireDrag(el){
  el.addEventListener("pointerdown", (ev)=>{
    ev.preventDefault();
    const id = Number(el.dataset.id);
    select(id);
    const e = state.elems.find(x=>x.id===id);
    const p = localXY(ev.clientX, ev.clientY);
    drag = {id, ox: e.x - p.x, oy: e.y - p.y};
    el.setPointerCapture(ev.pointerId);
    el.style.cursor="grabbing";
  });
  el.addEventListener("pointermove", (ev)=>{
    if(!drag) return;
    const e = state.elems.find(x=>x.id===drag.id);
    const p = localXY(ev.clientX, ev.clientY);
    e.x = p.x + drag.ox;
    e.y = p.y + drag.oy;
  });
  el.addEventListener("pointerup", ()=>{
    drag = null;
    el.style.cursor="grab";
  });
  el.addEventListener("wheel", (ev)=>{
    if(Number(el.dataset.id)!==state.selectedId) return;
    ev.preventDefault();
    const e = state.elems.find(x=>x.id===state.selectedId);
    const ds = ev.deltaY>0 ? -0.06 : 0.06;
    e.s = clamp(e.s + ds, 0.08, 6.0);
  }, {passive:false});
  el.addEventListener("click", (ev)=>{
    ev.stopPropagation();
    select(Number(el.dataset.id));
  });
}
card.addEventListener("click", ()=>select(null));

function select(id){
  state.selectedId = id;
  dock.style.display = id ? "flex" : "none";
}

/* ========= ADD ELEMENTS ========= */
function addImgByName(name, opts={}){
  const url = requireAssetOrExplain(name);
  if(!url) return null;
  return addImg(url, opts);
}
function addImg(src, opts={}){
  const r = cardRect();
  const e = {
    id: uid(),
    type:"img",
    src,
    x: r.width*0.5,
    y: r.height*0.62,
    s: opts.s ?? 1.0,
    r: opts.r ?? 0,
    z: opts.z ?? (state.elems.length? Math.max(...state.elems.map(x=>x.z))+1 : 10),
    floatAmp: opts.floatAmp ?? (opts.isLogo? 2.2 : 6.5),
    floatPhase: Math.random()*6.28,
    isLogo: !!opts.isLogo,
    meta: opts.meta || {}
  };
  state.elems.push(e);
  select(e.id);
  clearError();
  return e;
}
function addEmoji(char, opts={}){
  const r = cardRect();
  const e = {
    id: uid(),
    type:"emoji",
    char,
    x: r.width*0.2 + Math.random()*r.width*0.6,
    y: r.height*0.28 + Math.random()*r.height*0.55,
    s: opts.s ?? 1.0,
    r: opts.r ?? 0,
    z: opts.z ?? (state.elems.length? Math.max(...state.elems.map(x=>x.z))+1 : 10),
    floatAmp: opts.floatAmp ?? 7.5,
    floatPhase: Math.random()*6.28,
    meta: opts.meta || {}
  };
  state.elems.push(e);
  select(e.id);
  clearError();
  return e;
}
function addText(text, opts={}){
  const r = cardRect();
  const e = {
    id: uid(),
    type:"text",
    text,
    x: r.width*0.5,
    y: r.height*0.80,
    s: opts.s ?? 1.0,
    r: opts.r ?? 0,
    z: opts.z ?? (state.elems.length? Math.max(...state.elems.map(x=>x.z))+1 : 10),
    floatAmp: opts.floatAmp ?? 5.8,
    floatPhase: Math.random()*6.28
  };
  state.elems.push(e);
  select(e.id);
  clearError();
  return e;
}

/* ========= TILES ========= */
function tileImg(label, name, onClick){
  const t = document.createElement("div");
  t.className="tile";
  const url = assetMap.has(name) ? assetMap.get(name) : resolveAsset(name);
  t.innerHTML = `<div class="thumb"><img src="${url}" alt=""></div><div class="lbl">${label}</div>`;
  t.addEventListener("click", onClick);
  return t;
}
function tileEmoji(label, ch, onClick){
  const t = document.createElement("div");
  t.className="tile";
  t.innerHTML = `<div class="thumb"><div class="emoji">${ch}</div></div><div class="lbl">${label}</div>`;
  t.addEventListener("click", onClick);
  return t;
}

function initTiles(){
  const logoTiles = document.getElementById("logoTiles");
  logoTiles.innerHTML = "";
  logoTiles.appendChild(tileImg("POL", ASSET_NAMES.pol, ()=>addImgByName(ASSET_NAMES.pol, {isLogo:true, s:1.00, meta:{logoPart:"POL"}})));
  logoTiles.appendChild(tileImg("Emoji ‚ÄûO‚Äù", ASSET_NAMES.emojiO, ()=>addImgByName(ASSET_NAMES.emojiO, {isLogo:true, s:0.82, meta:{logoPart:"O"}})));
  logoTiles.appendChild(tileImg("3D", ASSET_NAMES.threeD, ()=>addImgByName(ASSET_NAMES.threeD, {isLogo:true, s:1.00, meta:{logoPart:"3D"}})));
  logoTiles.appendChild(tileImg(".com", ASSET_NAMES.dotcom, ()=>addImgByName(ASSET_NAMES.dotcom, {isLogo:true, s:0.85, meta:{logoPart:"COM"}})));
  logoTiles.appendChild(tileImg("POLSKA‚Ä¶", ASSET_NAMES.tagline, ()=>addImgByName(ASSET_NAMES.tagline, {isLogo:true, s:1.15, meta:{logoPart:"TAG"}})));
  logoTiles.appendChild(tileImg("Mt. Hood (kolor)", ASSET_NAMES.hoodColor, ()=>addImgByName(ASSET_NAMES.hoodColor, {isLogo:true, s:1.00, meta:{hoodColorable:true, logoPart:"HOODC"}})));
  logoTiles.appendChild(tileImg("Mt. Hood (wire)", ASSET_NAMES.hoodWire, ()=>addImgByName(ASSET_NAMES.hoodWire, {isLogo:true, s:1.35, meta:{logoPart:"HOODW"}})));

  const holidayTiles = document.getElementById("holidayTiles");
  holidayTiles.innerHTML = "";
  const holiday = [
    ["Choinka","üéÑ"],["Miko≈Çaj","üéÖ"],["Prezenty","üéÅ"],["Cukierek","üç¨"],
    ["Skarpeta","üß¶"],["Dzwonek","üîî"],["≈önieg","‚ùÑÔ∏è"],["Gwiazdka","‚≠ê"],
    ["Ba≈Çwan","‚õÑ"],["Renifer","ü¶å"],["≈öwieczka","üïØÔ∏è"],["Serce","‚ù§Ô∏è"]
  ];
  for(const [lbl,ch] of holiday){
    holidayTiles.appendChild(tileEmoji(lbl, ch, ()=>addEmoji(ch, {s:0.95})));
  }
}

/* ========= WATERMARK ========= */
function applyWatermark(){
  const url = assetMap.has(ASSET_NAMES.watermark) ? assetMap.get(ASSET_NAMES.watermark) : resolveAsset(ASSET_NAMES.watermark);
  wmDiv.style.backgroundImage = `url("${url}")`;
  wmDiv.style.setProperty("--wmSize", "82%");
  wmDiv.style.setProperty("--wmRot", "-2deg");
}

/* ========= LIGHTS ========= */
(function(){
  const colors = ["#ff2e63","#00d26a","#7a4dff","#ffbf00","#7cd6ff","#ff3d5d","#00c56f","#9b59ff","#ffb300","#4bd2ff"];
  const lights = document.getElementById("lights");
  for(let i=0;i<12;i++){
    const b=document.createElement("div");
    b.className="bulb";
    b.style.background=colors[i%colors.length];
    lights.appendChild(b);
  }
})();

/* ========= HOOD FILTER ========= */
function hoodFilterCSS(mode){
  if(mode==="orig") return "drop-shadow(0 16px 18px rgba(0,0,0,.22))";
  if(mode==="rg") return "hue-rotate(320deg) saturate(1.35) contrast(1.05) drop-shadow(0 16px 18px rgba(0,0,0,.22))";
  if(mode==="wb") return "saturate(.55) contrast(1.10) brightness(1.05) drop-shadow(0 16px 18px rgba(0,0,0,.22))";
  if(mode==="cool") return "hue-rotate(210deg) saturate(1.10) brightness(1.06) drop-shadow(0 16px 18px rgba(0,0,0,.22))";
  return "drop-shadow(0 16px 18px rgba(0,0,0,.22))";
}
document.getElementById("hoodColor").addEventListener("change", ()=>{});

/* ========= TEXT ADD ========= */
document.getElementById("addTextBtn").addEventListener("click", ()=>{
  const inp = document.getElementById("addText");
  const v = inp.value.trim();
  if(!v) return;
  addText(v, {s:0.85});
  inp.value="";
});

/* ========= FILE UPLOAD ========= */
function fileToDataURL(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
document.getElementById("fileSticker").addEventListener("change", async (ev)=>{
  try{
    const f = ev.target.files?.[0]; if(!f) return;
    const url = await fileToDataURL(f);
    addImg(url, {s:0.9, meta:{kind:"sticker"}});
  }catch(err){ showError("Nie uda≈Ço siƒô wczytaƒá pliku sticker.", err); }
  ev.target.value="";
});
document.getElementById("filePhoto").addEventListener("change", async (ev)=>{
  try{
    const f = ev.target.files?.[0]; if(!f) return;
    const url = await fileToDataURL(f);
    addImg(url, {s:0.85, meta:{kind:"photo"}});
  }catch(err){ showError("Nie uda≈Ço siƒô wczytaƒá pliku photo.", err); }
  ev.target.value="";
});

/* ========= DOCK ========= */
function sel(){ return state.elems.find(e=>e.id===state.selectedId); }
function bring(delta){
  const e=sel(); if(!e) return;
  e.z += delta;
}
document.getElementById("bPlus").onclick=()=>{ const e=sel(); if(e) e.s=clamp(e.s+0.12,0.08,6); };
document.getElementById("bMinus").onclick=()=>{ const e=sel(); if(e) e.s=clamp(e.s-0.12,0.08,6); };
document.getElementById("bRot").onclick=()=>{ const e=sel(); if(e) e.r = (e.r+10)%360; };
document.getElementById("bUp").onclick=()=>bring(1);
document.getElementById("bDown").onclick=()=>bring(-1);
document.getElementById("bDel").onclick=()=>{
  const id=state.selectedId;
  if(!id) return;
  state.elems = state.elems.filter(e=>e.id!==id);
  select(null);
};

/* ========= SNOW ========= */
const snow = document.getElementById("snow");
const sctx = snow.getContext("2d");
let flakes = [];
function resizeSnow(){
  snow.width = innerWidth * devicePixelRatio;
  snow.height = innerHeight * devicePixelRatio;
  snow.style.width = innerWidth+"px";
  snow.style.height = innerHeight+"px";
  sctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  flakes = Array.from({length:120}, ()=>({
    x: Math.random()*innerWidth,
    y: Math.random()*innerHeight,
    r: 1+Math.random()*2.6,
    vy: 0.4+Math.random()*1.1,
    vx: -0.25+Math.random()*0.5,
    a: 0.35+Math.random()*0.6
  }));
}
addEventListener("resize", resizeSnow);
resizeSnow();
function snowTick(){
  if(!snowOn){ sctx.clearRect(0,0,innerWidth,innerHeight); requestAnimationFrame(snowTick); return; }
  sctx.clearRect(0,0,innerWidth,innerHeight);
  for(const f of flakes){
    f.x += f.vx; f.y += f.vy;
    if(f.y>innerHeight+10){ f.y=-10; f.x=Math.random()*innerWidth; }
    if(f.x<-10) f.x=innerWidth+10;
    if(f.x>innerWidth+10) f.x=-10;
    sctx.globalAlpha = f.a;
    sctx.beginPath(); sctx.arc(f.x,f.y,f.r,0,Math.PI*2);
    sctx.fillStyle="white"; sctx.fill();
  }
  sctx.globalAlpha=1;
  requestAnimationFrame(snowTick);
}
snowTick();
document.getElementById("toggleSnow").onclick=()=>{
  snowOn = !snowOn;
  document.getElementById("toggleSnow").textContent = "≈önieg: " + (snowOn?"ON":"OFF");
};

/* ========= SOUND (disabled by default) ========= */
let audioCtx=null;
function ping(){
  if(!soundOn) return;
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const t = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type="triangle";
  o.frequency.setValueAtTime(880, t);
  o.frequency.exponentialRampToValueAtTime(440, t+0.12);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.08, t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.16);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(t); o.stop(t+0.18);
}
document.getElementById("toggleSound").onclick=()=>{
  soundOn = !soundOn;
  document.getElementById("toggleSound").textContent = "D≈∫wiƒôki: " + (soundOn?"ON":"OFF");
  if(soundOn) ping();
};

/* ========= EXPORT ========= */
async function loadImage(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    // For http://localhost, allow same-origin; for file input objectURLs, it's safe.
    img.onload=()=>res(img);
    img.onerror=(e)=>rej(new Error("Nie uda≈Ço siƒô wczytaƒá obrazu: "+src));
    img.src=src;
  });
}
function currentCardSize(){
  const r=cardRect();
  return {w:r.width, h:r.height};
}
function computeExportTransform(outW,outH){
  const cur = currentCardSize();
  return {sx: outW/cur.w, sy: outH/cur.h};
}

async function exportPNG(){
  clearError();
  const [outW,outH] = formatSel.value.split("x").map(n=>parseInt(n,10));
  const c = document.createElement("canvas");
  c.width = outW; c.height = outH;
  const ctx = c.getContext("2d");

  // background
  ctx.fillStyle = "#fff7ea";
  ctx.fillRect(0,0,outW,outH);

  // warm gradients
  const g1 = ctx.createRadialGradient(outW*0.2,outH*0.3, 10, outW*0.2,outH*0.3, Math.max(outW,outH)*0.9);
  g1.addColorStop(0, "rgba(255,210,230,.65)");
  g1.addColorStop(1, "rgba(255,255,255,0)");
  ctx.fillStyle = g1; ctx.fillRect(0,0,outW,outH);

  const g2 = ctx.createRadialGradient(outW*0.8,outH*0.22, 10, outW*0.8,outH*0.22, Math.max(outW,outH)*0.9);
  g2.addColorStop(0, "rgba(255,230,160,.72)");
  g2.addColorStop(1, "rgba(255,255,255,0)");
  ctx.fillStyle = g2; ctx.fillRect(0,0,outW,outH);

  // watermark
  try{
    const wmUrl = requireAssetOrExplain(ASSET_NAMES.watermark) || resolveAsset(ASSET_NAMES.watermark);
    const wm = await loadImage(wmUrl);
    const target = 0.82;
    const scale = (outW*target) / wm.width;
    const ww = wm.width*scale;
    const hh = wm.height*scale;
    ctx.save();
    ctx.translate(outW/2, outH/2);
    ctx.rotate(-2*Math.PI/180);
    ctx.globalAlpha = 0.16;
    ctx.drawImage(wm, -ww/2, -hh/2, ww, hh);
    ctx.restore();
  }catch(e){ /* ignore */ }

  // headline + deck + chips
  ctx.save();
  ctx.fillStyle = "#173b2e";
  ctx.textAlign="center";
  ctx.font = "900 "+Math.round(outW*0.055)+"px ui-sans-serif, system-ui, Segoe UI";
  ctx.fillText("Weso≈Çych ≈öwiƒÖt od POL3D!", outW/2, outH*0.14);

  ctx.fillStyle = "#3a3a3a";
  ctx.font = "500 "+Math.round(outW*0.022)+"px ui-sans-serif, system-ui, Segoe UI";
  const deck = "POL3D to projekt m≈Çodzie≈ºy z Polskiej Szko≈Çy w Portland: od pomys≈Çu, przez prototyp, a≈º po sprzeda≈º. Z tej okazji ‚Äî baw siƒô kartkƒÖ i rozsy≈Çaj dalej.";
  wrapText(ctx, deck, outW/2, outH*0.19, outW*0.78, Math.round(outW*0.03));

  const toV = document.getElementById("toField").value;
  const fromV = document.getElementById("fromField").value;
  drawChip(ctx, outW*0.40, outH*0.28, "üåü", "Dla:", toV);
  drawChip(ctx, outW*0.60, outH*0.28, "üéÅ", "Od:", fromV);
  ctx.restore();

  const {sx,sy} = computeExportTransform(outW,outH);
  const elems = [...state.elems].sort((a,b)=>a.z-b.z);

  for(const e of elems){
    ctx.save();
    ctx.translate(e.x*sx, e.y*sy);
    ctx.rotate(e.r*Math.PI/180);
    ctx.scale(e.s*sx, e.s*sy);

    if(e.type==="img"){
      const im = await loadImage(e.src);
      const w = im.width, h = im.height;
      if(e.meta?.kind==="photo"){
        ctx.shadowColor="rgba(0,0,0,.25)";
        ctx.shadowBlur=30;
        ctx.shadowOffsetY=18;
        roundImage(ctx, im, -w/2, -h/2, w, h, 18);
      }else{
        ctx.shadowColor="rgba(0,0,0,.22)";
        ctx.shadowBlur=28;
        ctx.shadowOffsetY=18;
        ctx.drawImage(im, -w/2, -h/2, w, h);
      }
    }else if(e.type==="emoji"){
      ctx.shadowColor="rgba(0,0,0,.20)";
      ctx.shadowBlur=22;
      ctx.shadowOffsetY=14;
      ctx.font = "70px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(e.char, 0, 0);
    }else if(e.type==="text"){
      ctx.shadowColor="rgba(0,0,0,.18)";
      ctx.shadowBlur=22;
      ctx.shadowOffsetY=14;
      ctx.font = "900 56px ui-sans-serif, system-ui, Segoe UI";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      const padX=18, padY=14;
      const metrics = ctx.measureText(e.text);
      const bw = metrics.width + padX*2;
      const bh = 56 + padY*2;
      ctx.fillStyle="rgba(255,255,255,.55)";
      roundRect(ctx, -bw/2, -bh/2, bw, bh, 16); ctx.fill();
      ctx.strokeStyle="rgba(0,0,0,.06)";
      ctx.lineWidth=2; ctx.stroke();
      ctx.fillStyle="#111";
      ctx.fillText(e.text, 0, 3);
    }
    ctx.restore();
  }

  // border
  ctx.save();
  ctx.lineWidth = Math.round(outW*0.012);
  ctx.strokeStyle = "rgba(255,244,220,.95)";
  roundRect(ctx, ctx.lineWidth/2, ctx.lineWidth/2, outW-ctx.lineWidth, outH-ctx.lineWidth, 28);
  ctx.stroke();
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(150,120,90,.35)";
  roundRect(ctx, 10, 10, outW-20, outH-20, 22);
  ctx.setLineDash([8,10]);
  ctx.stroke();
  ctx.restore();

  // IMPORTANT: export via Blob + modal (prevents blocked auto-download)
  try{
    const blob = await new Promise((res)=>c.toBlob(res, "image/png"));
    if(!blob) throw new Error("toBlob() zwr√≥ci≈Ç null.");
    const url = URL.createObjectURL(blob);
    const file = new File([blob], "POL3D_kartka.png", {type:"image/png"});
    openExportModal(url, file);
  }catch(err){
    // If we hit SecurityError, explain exact cause
    if(err && (err.name==="SecurityError" || String(err).includes("SecurityError"))){
      showError("SecurityError przy eksporcie. Je≈õli otwierasz HTML przez file:// i u≈ºywasz obraz√≥w z dysku, przeglƒÖdarka blokuje odczyt canvas. RozwiƒÖzanie: wybierz folder z assetami (po lewej) albo uruchom przez http://localhost.", err);
    }else{
      showError("Eksport PNG nie powi√≥d≈Ç siƒô.", err);
    }
  }
}

let lastExportFile = null;
let lastExportObjectUrl = null;

function openExportModal(objectUrl, file){
  const modal = document.getElementById("modal");
  const img = document.getElementById("previewImg");
  const link = document.getElementById("downloadLink");
  const status = document.getElementById("sendStatus");
  const shareBtn = document.getElementById("shareBtn");

  // cleanup previous URL
  if(lastExportObjectUrl && lastExportObjectUrl.startsWith("blob:")){
    try{ URL.revokeObjectURL(lastExportObjectUrl); }catch(_){}
  }

  lastExportFile = file || null;
  lastExportObjectUrl = objectUrl;

  img.src = objectUrl;
  link.href = objectUrl;

  if(status) status.textContent = "";
  if(shareBtn){
    const ok = !!(navigator.share && navigator.canShare && lastExportFile && navigator.canShare({files:[lastExportFile]}));
    shareBtn.style.display = ok ? "inline-flex" : "none";
  }

  modal.style.display = "flex";
}


document.getElementById("closeModal").onclick=()=>{
  document.getElementById("modal").style.display="none";
  if(lastExportObjectUrl && lastExportObjectUrl.startsWith("blob:")){
    try{ URL.revokeObjectURL(lastExportObjectUrl); }catch(_){ }
  }
  lastExportObjectUrl = null;
  lastExportFile = null;
  const st = document.getElementById("sendStatus");
  if(st) st.textContent = "";
};
/* ========= SEND / SHARE ========= */
// Configure a backend endpoint if you want true email sending with attachment.
// Example: "/.netlify/functions/send-card" (Netlify Function) or "/api/send-card" (via redirects). Leave as empty to disable backend sending.
const SEND_ENDPOINT = "/.netlify/functions/send-card";

async function fileToBase64DataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||""));
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

async function sendEmailViaEndpoint(to, file){
  if(!SEND_ENDPOINT) throw new Error("Brak skonfigurowanego endpointu do wysy≈Çki.");
  // Send JSON (no multipart parsing needed on the serverless side)
  const dataUrl = await fileToBase64DataURL(file);
  const base64 = (dataUrl.split(",")[1] || "").trim();
  if(!base64) throw new Error("Nie uda≈Ço siƒô zakodowaƒá pliku PNG.");
  const payload = { to, filename: file.name, mime: file.type || "image/png", base64 };
  const res = await fetch(SEND_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(t || ("HTTP " + res.status));
  }
  return res.json().catch(()=> ({}));
}

document.getElementById("sendEmailBtn").onclick = async ()=>{
  const status = document.getElementById("sendStatus");
  try{
    clearError();
    const to = (document.getElementById("emailTo").value || "").trim();
    if(!lastExportFile) throw new Error("Najpierw wykonaj eksport PNG (przycisk ‚ÄûWyeksportuj‚Ä¶‚Äù).");
    if(!to) throw new Error("Wpisz adres e-mail odbiorcy.");
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(to)) throw new Error("Adres e-mail wyglƒÖda na niepoprawny.");

    if(status) status.textContent = "Wysy≈Çanie‚Ä¶";
    await sendEmailViaEndpoint(to, lastExportFile);
    if(status) status.textContent = "Wys≈Çano.";
  }catch(err){
    if(status) status.textContent = "Nie wys≈Çano: " + (err?.message || String(err));
  }
};

document.getElementById("shareBtn").onclick = async ()=>{
  const status = document.getElementById("sendStatus");
  try{
    clearError();
    if(!lastExportFile) throw new Error("Najpierw wykonaj eksport PNG (przycisk ‚ÄûWyeksportuj‚Ä¶‚Äù).");
    if(!(navigator.share && navigator.canShare && navigator.canShare({files:[lastExportFile]}))){
      throw new Error("Udostƒôpnianie plik√≥w nie jest wspierane w tej przeglƒÖdarce lub wymaga HTTPS.");
    }
    await navigator.share({ title:"POL3D ‚Äî kartka", text:"Kartka ≈õwiƒÖteczna POL3D", files:[lastExportFile] });
    if(status) status.textContent = "";
  }catch(err){
    if(status) status.textContent = "Nie udostƒôpniono: " + (err?.message || String(err));
  }
};


function roundRect(ctx,x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split(" ");
  let line = "";
  let yy = y;
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + " ";
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      ctx.fillText(line, x, yy);
      line = words[n] + " ";
      yy += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, yy);
}
function drawChip(ctx, x, y, emoji, label, value){
  ctx.save();
  ctx.font = "600 18px ui-sans-serif, system-ui, Segoe UI";
  const txt = label+" "+value;
  const w = ctx.measureText(txt).width + 60;
  const h = 44;
  ctx.fillStyle="rgba(255,255,255,.78)";
  ctx.strokeStyle="rgba(0,0,0,.08)";
  ctx.lineWidth=2;
  ctx.shadowColor="rgba(0,0,0,.10)";
  ctx.shadowBlur=18;
  ctx.shadowOffsetY=12;
  roundRect(ctx, x-w/2, y-h/2, w, h, 999);
  ctx.fill(); ctx.stroke();
  ctx.shadowColor="transparent";
  ctx.fillStyle="#2a2a2a";
  ctx.textAlign="left";
  ctx.textBaseline="middle";
  ctx.font = "18px Apple Color Emoji, Segoe UI Emoji";
  ctx.fillText(emoji, x-w/2+18, y+1);
  ctx.font = "600 16px ui-sans-serif, system-ui, Segoe UI";
  ctx.fillText(label, x-w/2+46, y+1);
  ctx.font = "500 16px ui-sans-serif, system-ui, Segoe UI";
  ctx.fillText(value, x-w/2+90, y+1);
  ctx.restore();
}
function roundImage(ctx, img, x, y, w, h, r){
  ctx.save();
  roundRect(ctx, x, y, w, h, r);
  ctx.clip();
  ctx.drawImage(img, x, y, w, h);
  ctx.restore();
}

document.getElementById("exportBtn").onclick=exportPNG;

/* ========= FORMAT CHANGE ========= */
formatSel.addEventListener("change", ()=>{
  const before = currentCardSize();
  const [w,h] = formatSel.value.split("x").map(n=>parseInt(n,10));
  cardWrap.style.aspectRatio = (w/h).toString();
  requestAnimationFrame(()=>{
    const after = currentCardSize();
    const sx = after.w / Math.max(1, before.w);
    const sy = after.h / Math.max(1, before.h);
    for(const e of state.elems){
      e.x *= sx; e.y *= sy;
    }
  });
});

/* ========= ASSET FOLDER PICKER ========= */
document.getElementById("assetFolder").addEventListener("change", async (ev)=>{
  try{
    clearError();
    const files = Array.from(ev.target.files || []);
    // cleanup previous objectURLs
    for(const [k,v] of assetMap.entries()){
      if(typeof v === "string" && v.startsWith("blob:")) URL.revokeObjectURL(v);
    }
    assetMap.clear();

    for(const f of files){
      // keep only filename (folder path irrelevant)
      const name = f.name;
      // map only png/jpg/webp (ignore others)
      if(!/\.(png|jpg|jpeg|webp|gif)$/i.test(name)) continue;
      const url = URL.createObjectURL(f);
      assetMap.set(name, url);
    }

    // status
    const needed = Object.values(ASSET_NAMES);
    const have = needed.filter(n=>assetMap.has(n)).length;
    assetStatus.textContent = have + "/" + needed.length;

    // re-init UI that uses assets
    initTiles();
    applyWatermark();

    if(location.protocol==="file:" && have<needed.length){
      showError("Nie wszystkie pliki PNG zosta≈Çy znalezione w folderze. Brakuje: " + needed.filter(n=>!assetMap.has(n)).join(", "), null);
    }else{
      clearError();
    }
  }catch(err){
    showError("Nie uda≈Ço siƒô za≈Çadowaƒá folderu z assetami.", err);
  }
});

/* ========= INIT ========= */
initTiles();
applyWatermark();
assetStatus.textContent = "0/" + Object.values(ASSET_NAMES).length;
if(location.protocol !== "file:"){
  const det = document.getElementById("assetFolder")?.closest("details");
  if(det) det.style.display = "none";
}

/* ========= MAIN TICK ========= */
function tick(){ renderAll(); requestAnimationFrame(tick); }
tick();
</script>
</body>
</html>
